import{dH as Q,u as Y,c as ee,a as se,d as te,r,e0 as ae,j as e,B as x,e1 as re,e2 as ie,e3 as ne}from"./index-CcNgdVLz.js";import{B as _}from"./Button-B4_V5GRV.js";import{T as le}from"./TextArea-UacOCLQt.js";import{P as oe,S as ce,A as de}from"./Send-CuX0frdP.js";import{C as me}from"./Close-eApB0hKv.js";import{S as a}from"./skeleton-DjwwWlQi.js";import{J as he}from"./jodit-react-B7Ng6XVx.js";import{A as xe}from"./Alert-U3gIVFWt.js";import{T as l}from"./Typography-BMOygWke.js";import{C as ue}from"./Chip-YFG14ne-.js";import{A as k}from"./Avatar-D05Y1472.js";import{F as fe}from"./file-text-Bw02Bdpn.js";import{T as pe}from"./Tooltip-C-v54PpA.js";import{I as O}from"./AlertTitle-C4QpKbd8.js";import{D as ge,a as je}from"./Dialog-BdfS6Lfy.js";import{D as we}from"./DialogTitle-BbPUlM9A.js";import"./createLucideIcon-XjDe6m21.js";import"./createSvgIcon-ClJPFlmG.js";import"./utils-BtYGnpaM.js";import"./useSlotProps-z1QAC-gu.js";import"./CircularProgress-CVM8C023.js";const be=()=>{var B,E,F,M,z;const{id:b}=Q(),{search:H}=Y(),T=new URLSearchParams(H).get("userType")||"Buyer",U=2*1024*1024,u=ee();se();const{currentTicket:t}=te(s=>s.supportticket),$=r.useRef(null),[y,A]=r.useState(""),[c,I]=r.useState(null),[ye,Ne]=r.useState(!1),[f,d]=r.useState(null),[P,m]=r.useState(""),[J,n]=r.useState(!1),[g,C]=r.useState(""),[j,L]=r.useState("status"),[p,D]=r.useState(void 0),[X,w]=r.useState(!1),[R,W]=r.useState(!1),[V,Z]=r.useState(!0);if(r.useEffect(()=>{const s=setTimeout(()=>Z(!1),1e3);return()=>clearTimeout(s)},[]),r.useEffect(()=>{b&&u(ae({id:b,userType:T}))},[u,b,T]),!t)return e.jsx("div",{className:"p-4",children:"Loading ticket details..."});const N=(t==null?void 0:t.status)==="Resolved",q={readonly:!1,height:150,toolbarSticky:!1,showXPathInStatusbar:!1,buttons:["bold","italic","|","align"],controls:{align:{list:{left:"Align Left",center:"Align Center",right:"Align Right",justify:"Justify"}}},placeholder:"Type your reply..."},G=()=>e.jsxs("div",{className:"flex min-h-screen bg-gray-50",children:[e.jsxs("main",{className:"flex-1 p-6",children:[e.jsx(a,{height:32,width:300,className:"mb-4"}),e.jsxs("div",{className:"bg-gray-200 p-4 rounded-md shadow mb-6",children:[e.jsx(a,{height:24,width:200,className:"mb-2"}),e.jsx(a,{count:3}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(a,{width:100,height:20}),e.jsx(a,{width:100,height:20})]})]}),[1,2,3].map((s,i)=>e.jsxs("div",{className:"flex gap-2 justify-start mb-4",children:[e.jsx(a,{circle:!0,width:40,height:40}),e.jsxs("div",{children:[e.jsx(a,{height:18,width:120,className:"mb-1"}),e.jsx(a,{height:20,width:300})]})]},i)),e.jsxs("div",{className:"border bg-white px-10 py-3 space-y-4",children:[e.jsx(a,{height:36,width:100}),e.jsx(a,{height:150})]})]}),e.jsxs("aside",{className:"w-[340px] sticky top-14 self-start bg-white border-l p-4 flex flex-col justify-between",children:[e.jsxs("div",{className:"flex flex-col items-center text-center space-y-2",children:[e.jsx(a,{circle:!0,width:60,height:60}),e.jsx(a,{width:100}),e.jsx(a,{width:120}),e.jsx(a,{width:160})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg shadow p-3 mt-6",children:[e.jsx(a,{height:80}),e.jsx(a,{height:36,width:100,className:"mt-2 mx-auto"})]}),e.jsxs("div",{className:"mt-4 space-y-2",children:[e.jsx(a,{width:150,height:24}),e.jsx(a,{height:40,count:3})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg shadow p-3 mt-6",children:[e.jsx(a,{width:120,height:24,className:"mb-2"}),e.jsx(a,{height:36,className:"mb-2"}),e.jsx(a,{height:36,width:150,className:"mx-auto"})]})]})]});return V?e.jsx(G,{}):(console.log("data",(B=t==null?void 0:t.userId)==null?void 0:B.name),e.jsxs(e.Fragment,{children:[J&&f&&e.jsx("div",{className:"p-4",children:e.jsx(xe,{type:f,title:f==="success"?"Success!":f==="error"&&P.toLowerCase().includes("deleted")?"Deleted!":f==="error"?"Error!":"Warning!",message:P,variant:"filled",showLink:!1,linkHref:"",linkText:"",onClose:()=>n(!1)})}),e.jsxs("div",{className:"flex items-center justify-between bg-white px-4 py-3 border-b sticky top-0 z-10 pr-[380px]",children:[e.jsxs(l,{className:"font-outfit mb-0",variant:"h5",children:["Ticket Subject: ",t.subject]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-outfit text-sm text-gray-500",children:"Status:"}),(()=>{const s=String(t.status||"").toLowerCase();let i="error",o=t.status||"";return s==="resolved"?i="success":s==="in progress"?i="warning":s==="open"&&(i="error"),e.jsx(ue,{className:"font-outfit ml-2",label:o,color:i,size:"medium",variant:"filled"})})()]})]}),e.jsxs("div",{className:"flex min-h-screen overflow-hidden bg-gray-50",children:[e.jsxs("main",{className:"flex-1 overflow-y-auto h-screen p-6 pr-[380px]",children:[e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx(x,{className:"flex gap-2 justify-start",children:e.jsxs(x,{className:"p-3 rounded-2xl max-w-[50%] bg-gray-200 shadow break-words",style:{wordBreak:"break-word",overflowWrap:"break-word"},children:[e.jsx(l,{className:"font-outfit",variant:"subtitle1",fontWeight:600,children:"Issue Description"}),e.jsx("p",{className:"whitespace-pre-wrap",children:t.description}),(E=t.attachments)==null?void 0:E.map((s,i)=>{const o=typeof s=="string"?s:s&&typeof s=="object"&&s instanceof File?URL.createObjectURL(s):"",h=o.toLowerCase().endsWith(".pdf");return e.jsx("div",{onClick:()=>{D(o),w(!0)},className:"cursor-pointer mt-2 inline-block",children:h?e.jsxs("div",{className:"border p-2 rounded bg-gray-100 text-sm text-blue-700 w-fit hover:underline",children:["ðŸ“„ PDF Attachment ",i+1]}):e.jsx("img",{src:o,alt:`attachment-${i}`,className:"w-20 h-20 object-cover border rounded hover:opacity-80 transition"})},i)})]})}),(F=t.replies)==null?void 0:F.map((s,i)=>{var o;return e.jsxs(x,{className:`flex gap-2 ${s.sender==="Admin"?"justify-end":"justify-start"}`,children:[s.sender!=="Admin"&&e.jsx(k,{children:s.sender[0]}),e.jsxs(x,{className:`p-3 rounded-2xl max-w-[50%] break-words ${s.sender==="Admin"?"bg-blue-100":"bg-gray-200"}`,style:{wordBreak:"break-word",overflowWrap:"break-word"},children:[e.jsx(l,{component:"div",className:"font-outfit font-medium mb-1 whitespace-pre-wrap",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:s.message}})}),(o=s.attachments)==null?void 0:o.map((h,v)=>{const S=typeof h=="string"?h:h&&typeof h=="object"?URL.createObjectURL(h):"",K=S.toLowerCase().endsWith(".pdf");return e.jsx("div",{onClick:()=>{D(S),w(!0)},className:"cursor-pointer mt-2",children:K?e.jsxs("div",{className:"border p-2 rounded bg-gray-100 text-sm text-blue-700 w-fit hover:underline",children:[e.jsx(fe,{className:"text-red-500 w-5 h-5"}),"PDF Attachment ",v+1]}):e.jsx("img",{src:S,alt:`reply-img-${v}`,className:"font-outfit max-w-[100px] max-h-[100px] border rounded object-cover"})},v)}),e.jsx(l,{className:"font-outfit text-xs text-gray-500 mt-1",children:new Date(s.createdAt).toLocaleString("en-IN")})]}),s.sender==="Admin"&&e.jsx(k,{children:s.sender[0]})]},i)})]}),e.jsx("div",{className:"h-44"})]}),e.jsxs("aside",{className:"w-[350px] fixed right-0 top-[64px] h-[calc(100vh-64px)] bg-white border-l p-4 flex flex-col z-30",style:{boxShadow:"-2px 0 4px rgba(0,0,0,0.05)"},children:[e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(k,{sx:{width:60,height:60}}),e.jsx(l,{className:"font-outfit text-sm text-gray-500 mt-1",children:t.userType})]}),e.jsx("div",{className:"w-px bg-gray-300 h-16"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(l,{className:"font-outfit font-semibold",children:((M=t.userId)==null?void 0:M.name)||"User"}),t.userType==="Buyer"&&e.jsxs(l,{className:"font-outfit text-sm text-gray-500 flex items-center",children:[e.jsx(oe,{size:16,className:"mr-1"}),((z=t.userId)==null?void 0:z.phone)||"N/A"]})]})]}),!N&&e.jsxs("div",{className:"bg-gray-50 rounded-lg shadow p-3 mt-4",children:[e.jsx(le,{label:"Internal Notes",value:g,onChange:s=>C(s.target.value),rows:3,maxLength:300,hint:"Visible only to support staff"}),e.jsx("div",{className:"flex justify-center",children:e.jsx(_,{size:"xs",disabled:!g,className:"mt-2",onClick:()=>{if(!g.trim()){d("warning"),m("Please enter a note before saving."),n(!0);return}u(re({id:t._id,note:g,userType:t.userType})),C(""),d("success"),m("Internal note added successfully!"),n(!0),setTimeout(()=>n(!1),3e3)},children:"Save Note"})})]})]}),e.jsxs("div",{className:"mt-2 space-y-2 overflow-y-auto ",children:[e.jsx(l,{variant:"subtitle1",className:"font-outfit font-semibold",children:"Internal Notes"}),t.internalNotes&&t.internalNotes.length>0?t.internalNotes.map((s,i)=>e.jsx("div",{className:"bg-gray-100 text-sm p-2 rounded",children:s},i)):e.jsx(l,{className:"font-outfit text-sm text-gray-500",children:"No internal notes yet."})]}),!N&&e.jsxs("div",{className:"bg-gray-100 rounded-lg shadow p-3 mt-auto  bottom-0",children:[e.jsx(l,{component:"label",htmlFor:"ticketStatus",className:"font-outfit mb-2 block cursor-pointer select-none",children:"Ticket Status"}),e.jsxs("select",{value:j,onChange:s=>L(s.target.value),className:"w-full border border-gray-300 focus:border-black focus:ring-0 rounded-lg shadow px-3 py-2 mb-2",children:[e.jsx("option",{value:"status",children:"Select Ticket Status"}),t.status!=="In Progress"&&e.jsx("option",{value:"Open",children:"Open"}),e.jsx("option",{value:"In Progress",children:"In Progress"}),e.jsx("option",{value:"Resolved",children:"Resolved"})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(_,{size:"xs",disabled:R||j==="status",onClick:async()=>{if(j==="status"){d("warning"),m("Please select a valid ticket status."),n(!0);return}if(!y.trim()&&!(c!=null&&c.length)){d("warning"),m("Please enter a reply message or upload an attachment."),n(!0);return}if(c!=null&&c.some(s=>s.size>U)){d("warning"),m("Each attachment must be less than 2 MB."),n(!0);return}W(!0);try{await u(ie({id:t._id,userType:t.userType,message:y,attachments:c||void 0})).unwrap(),await u(ne({id:t._id,status:j,userType:t.userType})).unwrap(),d("success"),m("Status updated & reply sent successfully!"),n(!0),A(""),I(null),L("status")}catch(s){d("error"),m(s||"Failed to update status or send reply"),n(!0)}finally{setTimeout(()=>n(!1),4e3),W(!1)}},children:R?"Sending...":e.jsxs(e.Fragment,{children:["Send ",e.jsx(ce,{})]})})})]})]}),!N&&e.jsx("div",{className:"fixed left-0 right-[40px] bottom-2 z-20 flex justify-center",children:e.jsxs(x,{className:`bg-white border rounded-2xl shadow p-3 w-full ${window.innerWidth<1281?"max-w-xl":window.innerWidth<1580?"max-w-3xl":window.innerWidth<1715?"max-w-4xl":window.innerWidth<1760?"max-w-5xl":"max-w-6xl"}`,children:[e.jsx(x,{className:"flex items-center gap-2 mb-2",children:e.jsx(pe,{title:"Attach file",children:e.jsxs(O,{component:"label",children:[e.jsx(de,{}),e.jsx("input",{hidden:!0,type:"file",onChange:s=>I(Array.from(s.target.files||[]))})]})})}),e.jsx("div",{style:{minHeight:110},children:e.jsx(he,{ref:$,value:y,config:{...q,toolbarSticky:!0,toolbarStickyOffset:64,minHeight:110,maxHeight:220,readonly:!1,toolbarAdaptive:!1,placeholder:"Type your reply..."},tabIndex:1,onBlur:s=>A(s)})})]})}),e.jsxs(ge,{open:X,onClose:()=>w(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsxs(we,{className:"font-outfit flex justify-between items-center text-[#063f1f] font-semibold",children:["Preview",e.jsx(O,{onClick:()=>w(!1),children:e.jsx(me,{})})]}),e.jsx(je,{dividers:!0,children:p!=null&&p.endsWith(".pdf")?e.jsx("iframe",{src:p,width:"100%",height:"600px",title:"Document Preview",style:{border:"none"}}):e.jsx("img",{src:p,alt:"Preview",className:"w-full max-h-[600px] object-contain"})})]})]})]}))},$e=()=>e.jsx(e.Fragment,{children:e.jsx(be,{})});export{$e as default};
